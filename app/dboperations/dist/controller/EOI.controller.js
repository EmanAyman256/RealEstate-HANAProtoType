sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/Dialog","sap/m/Input","sap/m/Button","sap/m/Label","sap/m/Text","sap/m/VBox","sap/m/DatePicker","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/ui/model/json/JSONModel","sap/m/Title","sap/m/IconTabBar","sap/m/IconTabFilter","sap/ui/layout/form/SimpleForm","sap/m/HBox"],function(e,t,a,n,o,s,i,l,d,r,c,u,p,m,w,y,h,x){"use strict";return e.extend("dboperations.controller.EOI",{onInit:function(){this._loadEOIs()},_loadEOIs:function(){const e=new p;fetch("./odata/v4/real-estate/EOI?$expand=paymentDetails").then(e=>e.json()).then(t=>{e.setData({EOI:t.value||[]});this.getView().byId("eoiTable").setModel(e)}).catch(e=>{console.error("Error loading EOIs:",e);t.error("Error loading EOIs: "+e.message)})},onNavigateToAddEOI:function(){const e={eoiType:"",status:"",date:"",companyCode:"",projectId:"",totalEoiValue:0,collectedAmount:0,remainingAmount:0,nationality:"",mobile1:"",customerId:"",validatedBy:"",validatedOn:"",paymentDetails:[]};this._openAddEditDialog(e,false)},onEditEOI:function(e){const a=e.getSource().getBindingContext();if(!a)return t.warning("No EOI selected.");const n=Object.assign({},a.getObject());this._openAddEditDialog(n,true)},_openAddEditDialog:function(e,t){if(this._oAddDialog){this._oAddDialog.destroy();this._oAddDialog=null}const n=new p(e);this._oAddDialog=new a({title:t?"Edit EOI":"Add EOI",contentWidth:"100%",resizable:true,draggable:true,content:new l({items:this._createAddEditForm()}),beginButton:new o({text:"Save",type:"Emphasized",press:this.onSaveEOI.bind(this)}),endButton:new o({text:"Cancel",press:()=>this._oAddDialog.close()})});this._oAddDialog.setModel(n);this.getView().addDependent(this._oAddDialog);this._oAddDialog.open()},_createAddEditForm:function(){return[new s({text:"EOI Type"}),new n({value:"{/eoiType}"}),new s({text:"Status"}),new n({value:"{/status}"}),new s({text:"Date"}),new d({value:"{/date}",valueFormat:"yyyy-MM-dd"}),new s({text:"Company Code"}),new n({value:"{/companyCode}"}),new s({text:"Project ID"}),new n({value:"{/projectId}"}),new s({text:"Total EOI Value"}),new n({value:"{/totalEoiValue}",type:"Number"}),new s({text:"Collected Amount"}),new n({value:"{/collectedAmount}",type:"Number"}),new s({text:"Remaining Amount"}),new n({value:"{/remainingAmount}",type:"Number"}),new s({text:"Customer ID"}),new n({value:"{/customerId}"}),new s({text:"Nationality"}),new n({value:"{/nationality}"}),new s({text:"Mobile 1"}),new n({value:"{/mobile1}"}),new s({text:"Validated By"}),new n({value:"{/validatedBy}"}),new s({text:"Validated On"}),new d({value:"{/validatedOn}",valueFormat:"yyyy-MM-dd"}),new m({text:"Payment Details",level:"H3"}),new o({text:"Add Payment",press:this.onAddPaymentRow.bind(this)}),new r({id:"paymentDetailsTable",items:"{/paymentDetails}",columns:[new c({header:new s({text:"Receipt Type"})}),new c({header:new s({text:"Status"})}),new c({header:new s({text:"Payment Method"})}),new c({header:new s({text:"Amount"})}),new c({header:new s({text:"Due Date"})}),new c({header:new s({text:"House Bank"})}),new c({header:new s({text:"Collected Amount"})})],items:{path:"/paymentDetails",template:new u({cells:[new n({value:"{receiptType}"}),new n({value:"{receiptStatus}"}),new n({value:"{paymentMethod}"}),new n({value:"{amount}",type:"Number"}),new d({value:"{dueDate}",valueFormat:"yyyy-MM-dd"}),new n({value:"{houseBank}"}),new n({value:"{collectedAmount}",type:"Number"})]})}})]},onSaveEOI:function(){const e=this._oAddDialog.getModel().getData();const a=!!e.eoiId&&e.eoiId.trim()!=="";const n=a?e.eoiId:Date.now().toString().slice(-8);const o={eoiId:n,eoiType:e.eoiType,status:e.status,date:e.date||null,companyCode:e.companyCode,projectId:e.projectId,totalEoiValue:parseFloat(e.totalEoiValue)||0,collectedAmount:parseFloat(e.collectedAmount)||0,remainingAmount:parseFloat(e.remainingAmount)||0,nationality:e.nationality,mobile1:e.mobile1,customerId:e.customerId,validatedBy:e.validatedBy,validatedOn:e.validatedOn||null,paymentDetails:e.paymentDetails||[]};const s=a?"PATCH":"POST";const i=a?`./odata/v4/real-estate/EOI(eoiId='${encodeURIComponent(n)}')`:"./odata/v4/real-estate/EOI";console.log("EOI Save →",s,i,o);fetch(i,{method:s,headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(async e=>{if(!e.ok){const t=await e.text().catch(()=>"");throw new Error(t||"Save failed")}return e.text().then(e=>e?JSON.parse(e):{})}).then(()=>{this._loadEOIs();t.success(a?"EOI updated successfully!":"EOI created successfully!");this._oAddDialog.close()}).catch(e=>{console.error("Save error:",e);t.error("Save failed: "+e.message)})},onDetails:function(e){const n=e.getSource().getBindingContext();if(!n)return t.warning("No EOI selected.");const l=n.getObject();const d=new p(l);if(this._oDetailsDialog){this._oDetailsDialog.destroy();this._oDetailsDialog=null}this._oDetailsDialog=new a({title:"EOI Details",contentWidth:"900px",resizable:true,draggable:true,content:[new w({items:[new y({text:"General Data",icon:"sap-icon://home",content:new h({editable:false,content:[new s({text:"EOI ID"}),new i({text:"{/eoiId}"}),new s({text:"EOI Type"}),new i({text:"{/eoiType}"}),new s({text:"Status"}),new i({text:"{/status}"}),new s({text:"Date"}),new i({text:"{/date}"}),new s({text:"Company Code"}),new i({text:"{/companyCode}"}),new s({text:"Project ID"}),new i({text:"{/projectId}"}),new s({text:"Total Value"}),new i({text:"{/totalEoiValue}"}),new s({text:"Collected Amount"}),new i({text:"{/collectedAmount}"}),new s({text:"Remaining Amount"}),new i({text:"{/remainingAmount}"})]})}),new y({text:"Payment Details",icon:"sap-icon://money-bills",content:[new r({columns:[new c({header:new s({text:"Receipt Type"})}),new c({header:new s({text:"Status"})}),new c({header:new s({text:"Payment Method"})}),new c({header:new s({text:"Amount"})}),new c({header:new s({text:"Due Date"})}),new c({header:new s({text:"House Bank"})}),new c({header:new s({text:"Collected Amount"})})],items:{path:"/paymentDetails",template:new u({cells:[new i({text:"{receiptType}"}),new i({text:"{receiptStatus}"}),new i({text:"{paymentMethod}"}),new i({text:"{amount}"}),new i({text:"{dueDate}"}),new i({text:"{houseBank}"}),new i({text:"{collectedAmount}"})]})}})]})]})],endButton:new o({text:"Close",press:()=>this._oDetailsDialog.close()})});this._oDetailsDialog.setModel(d);this.getView().addDependent(this._oDetailsDialog);this._oDetailsDialog.open()},onAddReservationFromEOI:async function(e){const t=e.getSource().getBindingContext();if(!t){sap.m.MessageToast.show("No EOI selected.");return}const a=t.getObject();const n=new sap.ui.model.json.JSONModel({reservationId:"",companyCodeId:a.companyCode||"",oldReservationId:"",eoiId:a.eoiId||"",description:`Reservation for EOI ${a.eoiId}`,salesType:"",validFrom:(new Date).toISOString().split("T")[0],customerType:"",currency:"",afterSales:"",status:"Draft",project_projectId:a.projectId||"",building_buildingId:"",unit_unitId:"",paymentPlan_paymentPlanId:"",bua:0,phase:"",pricePlanYears:0,planYears:0,unitPrice:0,planCurrency:"",requestType:"",reason:"",cancellationDate:"",cancellationStatus:"",rejectionReason:"",cancellationFees:0,payments:[],partners:[],conditions:[]});if(!this._oAddReservationDialog){this._oAddReservationDialog=new sap.m.Dialog({title:"Add Reservation from EOI",contentWidth:"700px",contentHeight:"80%",resizable:true,draggable:true,class:"sapUiSizeCompact",content:[new sap.m.ScrollContainer({height:"100%",vertical:true,focusable:true,content:[new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",labelSpanL:4,columnsL:2,content:[new sap.m.Label({text:"EOI ID"}),new sap.m.Text({text:"{/eoiId}"}),new sap.m.Label({text:"Company Code"}),new sap.m.Text({text:"{/companyCodeId}"}),new sap.m.Label({text:"Project ID"}),new sap.m.Text({text:"{/project_projectId}"}),new sap.m.Label({text:"Description"}),new sap.m.Input({value:"{/description}"}),new sap.m.Label({text:"Sales Type"}),new sap.m.Input({value:"{/salesType}"}),new sap.m.Label({text:"Valid From"}),new sap.m.DatePicker({value:"{/validFrom}",displayFormat:"long",valueFormat:"yyyy-MM-dd",showClearIcon:true}),new sap.m.Label({text:"Currency"}),new sap.m.Input({value:"{/currency}"}),new sap.m.Label({text:"Customer Type"}),new sap.m.Input({value:"{/customerType}"}),new sap.m.Label({text:"After Sales"}),new sap.m.Input({value:"{/afterSales}"}),new sap.m.Label({text:"Phase"}),new sap.m.Input({value:"{/phase}"}),new sap.m.Label({text:"Unit Price"}),new sap.m.Input({value:"{/unitPrice}"}),new sap.m.Label({text:"BUA"}),new sap.m.Input({value:"{/bua}"}),new sap.m.Label({text:"Plan Years"}),new sap.m.Input({value:"{/planYears}"}),new sap.m.Label({text:"Price Plan Years"}),new sap.m.Input({value:"{/pricePlanYears}"}),new sap.m.Label({text:"Plan Currency"}),new sap.m.Input({value:"{/planCurrency}"}),new sap.m.Label({text:"Request Type"}),new sap.m.Input({value:"{/requestType}"}),new sap.m.Label({text:"Reason"}),new sap.m.Input({value:"{/reason}"}),new sap.m.Label({text:"Cancellation Date"}),new sap.m.DatePicker({value:"{/cancellationDate}",displayFormat:"long",valueFormat:"yyyy-MM-dd",showClearIcon:true}),new sap.m.Label({text:"Cancellation Status"}),new sap.m.Input({value:"{/cancellationStatus}"}),new sap.m.Label({text:"Cancellation Fees"}),new sap.m.Input({value:"{/cancellationFees}"})]})]})],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:async function(){const e=this._oAddReservationDialog.getModel().getData();try{const t=await fetch("./odata/v4/real-estate/Reservations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.json();throw new Error(e.error?.message||"Failed to create reservation")}sap.m.MessageToast.show("Reservation created successfully!");this._oAddReservationDialog.close()}catch(e){console.error("❌ Error creating reservation from EOI:",e);sap.m.MessageBox.error("Error: "+e.message)}}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._oAddReservationDialog.close()}.bind(this)})});this.getView().addDependent(this._oAddReservationDialog)}this._oAddReservationDialog.setModel(n);this._oAddReservationDialog.open()},onAddPaymentRow:function(){const e=this._oAddDialog.getModel();const t=e.getProperty("/paymentDetails")||[];t.push({receiptType:"",receiptStatus:"",paymentMethod:"",amount:0,dueDate:"",houseBank:"",collectedAmount:0});e.setProperty("/paymentDetails",t);e.refresh()},onDelete:function(e){const a=e.getSource().getBindingContext();if(!a)return;const n=a.getObject().eoiId;t.confirm(`Delete EOI ${n}?`,{onClose:e=>{if(e!==t.Action.OK)return;fetch(`/odata/v4/real-estate/EOI(eoiId='${encodeURIComponent(n)}')`,{method:"DELETE"}).then(()=>this._loadEOIs()).then(()=>t.success("EOI deleted successfully!")).catch(e=>t.error(e.message))}})}})});
//# sourceMappingURL=EOI.controller.js.map