sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel"],function(e,t,n,a){"use strict";return e.extend("dboperations.controller.Reservations",{onInit:function(){this.oModel=this.getView().getModel();this._loadReservations()},_loadReservations:function(){fetch("./odata/v4/real-estate/Reservations?$expand=payments,partners,conditions,project,building,unit").then(e=>e.json()).then(e=>{this.getView().setModel(new a(e.value||[]),"reservations")}).catch(e=>console.error("Failed to load reservations:",e))},onShowReservationDetails:async function(e){const t=e.getSource().getBindingContext("reservations");if(!t)return;const s=t.getProperty("reservationId");try{const e=await fetch(`./odata/v4/real-estate/Reservations(reservationId='${s}')?$expand=payments,partners,conditions,project,building,unit`);if(!e.ok)throw new Error("Failed to load reservation details");const t=await e.json();const n=t.value?t.value[0]:t;const o={...n,projectName:n.project?.name||"",projectId:n.project?.projectId||"",buildingName:n.building?.name||"",buildingId:n.building?.buildingId||"",unitNumber:n.unit?.unitNumber||"",unitId:n.unit?.unitId||"",payments:n.payments||[],partners:n.partners||[],conditions:n.conditions||[]};const r=new a(o);if(!this._oDetailsDialog){this._oDetailsDialog=new sap.m.Dialog({title:"Reservation Details",contentWidth:"90%",resizable:true,draggable:true,content:[new sap.m.IconTabBar({items:[new sap.m.IconTabFilter({text:"General Info",content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",content:[new sap.m.Label({text:"Reservation ID"}),new sap.m.Text({text:"{/reservationId}"}),new sap.m.Label({text:"Company Code"}),new sap.m.Text({text:"{/companyCodeId}"}),new sap.m.Label({text:"Old Reservation ID"}),new sap.m.Text({text:"{/oldReservationId}"}),new sap.m.Label({text:"EOI ID"}),new sap.m.Text({text:"{/eoiId}"}),new sap.m.Label({text:"Sales Type"}),new sap.m.Text({text:"{/salesType}"}),new sap.m.Label({text:"Description"}),new sap.m.Text({text:"{/description}"}),new sap.m.Label({text:"Valid From"}),new sap.m.Text({text:"{/validFrom}"}),new sap.m.Label({text:"Status"}),new sap.m.Text({text:"{/status}"}),new sap.m.Label({text:"Customer Type"}),new sap.m.Text({text:"{/customerType}"}),new sap.m.Label({text:"Currency"}),new sap.m.Text({text:"{/currency}"}),new sap.m.Label({text:"After Sales"}),new sap.m.Text({text:"{/afterSales}"})]})]}),new sap.m.IconTabFilter({text:"Unit Info",content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",content:[new sap.m.Label({text:"Project ID"}),new sap.m.Text({text:"{/projectId}"}),new sap.m.Label({text:"Project Name"}),new sap.m.Text({text:"{/projectName}"}),new sap.m.Label({text:"Building ID"}),new sap.m.Text({text:"{/buildingId}"}),new sap.m.Label({text:"Building Name"}),new sap.m.Text({text:"{/buildingName}"}),new sap.m.Label({text:"Unit ID"}),new sap.m.Text({text:"{/unitId}"}),new sap.m.Label({text:"Unit Number"}),new sap.m.Text({text:"{/unitNumber}"}),new sap.m.Label({text:"BUA"}),new sap.m.Text({text:"{/bua}"}),new sap.m.Label({text:"Phase"}),new sap.m.Text({text:"{/phase}"}),new sap.m.Label({text:"Price Plan Years"}),new sap.m.Text({text:"{/pricePlanYears}"})]})]}),new sap.m.IconTabFilter({text:"Payments",content:[new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:"Receipt Type"})}),new sap.m.Column({header:new sap.m.Label({text:"Status"})}),new sap.m.Column({header:new sap.m.Label({text:"Payment Method"})}),new sap.m.Column({header:new sap.m.Label({text:"Amount"})}),new sap.m.Column({header:new sap.m.Label({text:"House Bank"})}),new sap.m.Column({header:new sap.m.Label({text:"Due Date"})})],items:{path:"/payments",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{receiptType}"}),new sap.m.Text({text:"{receiptStatus}"}),new sap.m.Text({text:"{paymentMethod}"}),new sap.m.Text({text:"{amount}"}),new sap.m.Text({text:"{houseBank}"}),new sap.m.Text({text:"{dueDate}"})]})}})]}),new sap.m.IconTabFilter({text:"Partners",content:[new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:"Customer Code"})}),new sap.m.Column({header:new sap.m.Label({text:"Name"})}),new sap.m.Column({header:new sap.m.Label({text:"Address"})}),new sap.m.Column({header:new sap.m.Label({text:"Valid From"})})],items:{path:"/partners",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{customerCode}"}),new sap.m.Text({text:"{customerName}"}),new sap.m.Text({text:"{customerAddress}"}),new sap.m.Text({text:"{validFrom}"})]})}})]}),new sap.m.IconTabFilter({text:"Conditions",content:[new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:"Type"})}),new sap.m.Column({header:new sap.m.Label({text:"Amount"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})}),new sap.m.Column({header:new sap.m.Label({text:"Frequency"})}),new sap.m.Column({header:new sap.m.Label({text:"Valid From"})}),new sap.m.Column({header:new sap.m.Label({text:"Valid To"})})],items:{path:"/conditions",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{conditionType}"}),new sap.m.Text({text:"{amount}"}),new sap.m.Text({text:"{currency}"}),new sap.m.Text({text:"{frequency}"}),new sap.m.Text({text:"{validFrom}"}),new sap.m.Text({text:"{validTo}"})]})}})]})]})],endButton:new sap.m.Button({text:"Close",press:function(){this._oDetailsDialog.close()}.bind(this)})});this.getView().addDependent(this._oDetailsDialog)}this._oDetailsDialog.setModel(r);this._oDetailsDialog.open()}catch(e){n.error("Error: "+e.message)}},onAddReservation:function(){this._openReservationDialog({})},onEditReservation:async function(e){const t=e.getSource().getBindingContext("reservations");const a=t.getProperty("reservationId");try{const e=await fetch(`./odata/v4/real-estate/Reservations(reservationId='${a}')?$expand=payments,partners,conditions,project,building,unit`);if(!e.ok)throw new Error("Failed to load reservation for edit");const t=await e.json();const n=t.value?t.value[0]:t;this._openReservationDialog(n)}catch(e){n.error("Error: "+e.message)}},_openReservationDialog:function(e){if(!this._oAddDialog){this._oAddDialog=this.getView().byId("reservationDialog")}const t=new sap.ui.model.json.JSONModel({reservationId:e.reservationId||"",companyCodeId:e.companyCodeId||"",oldReservationId:e.oldReservationId||"",eoiId:e.eoiId||"",salesType:e.salesType||"",description:e.description||"",validFrom:e.validFrom||"",status:e.status||"",customerType:e.customerType||"",currency:e.currency||"",afterSales:e.afterSales||"",project:e.project||null,building:e.building||null,unit:e.unit||null,bua:e.bua||0,phase:e.phase||"",pricePlanYears:e.pricePlanYears||0,paymentPlan:e.paymentPlan||null,planYears:e.planYears||0,unitPrice:e.unitPrice||0,planCurrency:e.planCurrency||"",requestType:e.requestType||"",reason:e.reason||"",cancellationDate:e.cancellationDate||"",cancellationStatus:e.cancellationStatus||"",rejectionReason:e.rejectionReason||"",cancellationFees:e.cancellationFees||0,payments:e.payments||[],partners:e.partners||[],conditions:e.conditions||[]});this._oAddDialog.setModel(t,"local");this._oAddDialog.open()},onSaveReservation:async function(){const e=this.byId("reservationDialog");const t=e.getModel("local");const n=t.getData();try{const t={reservationId:n.reservationId||undefined,companyCodeId:n.companyCodeId,oldReservationId:n.oldReservationId,eoiId:n.eoiId,description:n.description,salesType:n.salesType,validFrom:n.validFrom,customerType:n.customerType,currency:n.currency,afterSales:n.afterSales,status:n.status,project_projectId:n.project_projectId,building_buildingId:n.building_buildingId,unit_unitId:n.unit_unitId,paymentPlan_paymentPlanId:n.paymentPlan_paymentPlanId,bua:n.bua,phase:n.phase,pricePlanYears:n.pricePlanYears,planYears:n.planYears,unitPrice:n.unitPrice,planCurrency:n.planCurrency,requestType:n.requestType,reason:n.reason,cancellationDate:n.cancellationDate,cancellationStatus:n.cancellationStatus,rejectionReason:n.rejectionReason,cancellationFees:n.cancellationFees,payments:n.payments||[],partners:n.partners||[],conditions:n.conditions||[]};const a=t.reservationId?"PUT":"POST";const s=t.reservationId?`./odata/v4/real-estate/Reservations(reservationId='${t.reservationId}')`:`./odata/v4/real-estate/Reservations`;const o=await fetch(s,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){const e=await o.json();throw new Error(e.error?.message||"Failed to save reservation")}sap.m.MessageToast.show("Reservation saved successfully!");e.close();const r=this.getView().getModel("reservations");r.refresh()}catch(e){console.error("Error saving reservation:",e);sap.m.MessageBox.error("Failed to save reservation: "+e.message)}},onCancelReservation:function(){this._oAddDialog.close()},onDeleteReservation:function(e){const a=e.getSource().getBindingContext("reservations");const s=a.getObject();n.confirm(`Delete reservation ${s.reservationId}?`,{onClose:async e=>{if(e==="OK"){try{const e=await fetch(`./odata/v4/real-estate/Reservations('${s.reservationId}')`,{method:"DELETE"});if(!e.ok)throw new Error("Delete failed");t.show("Deleted successfully");this._loadReservations()}catch(e){n.error(e.message)}}}})},onAddPaymentRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/payments");t.push({});e.refresh()},onDeletePaymentRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/payments");t.pop();e.refresh()},onAddPartnerRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/partners");t.push({});e.refresh()},onDeletePartnerRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/partners");t.pop();e.refresh()},onAddConditionRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/conditions");t.push({});e.refresh()},onDeleteConditionRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/conditions");t.pop();e.refresh()}})});
//# sourceMappingURL=Reservations.controller.js.map