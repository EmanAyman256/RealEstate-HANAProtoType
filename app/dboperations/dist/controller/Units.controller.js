sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/Dialog","sap/m/Input","sap/m/Button","sap/m/Label","sap/m/Text","sap/m/TextArea","sap/m/VBox","sap/m/DatePicker","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/ui/model/json/JSONModel","sap/m/Title","sap/m/IconTabBar","sap/m/IconTabFilter","sap/ui/layout/form/SimpleForm","sap/m/ComboBox","sap/ui/core/Item","sap/m/MessageToast","sap/m/SelectDialog","sap/m/StandardListItem"],function(e,t,n,i,a,o,s,r,l,p,u,c,d,m,g,h,P,y,I,D,w,f,C){"use strict";return e.extend("dboperations.controller.Units",{onInit:function(){this.getOwnerComponent().getRouter().getRoute("Units").attachPatternMatched(this._onRouteMatched,this);var e=new sap.ui.model.json.JSONModel({Units:[]});e.setProperty("/selectedUnitStatus","");e.setProperty("/selectedUnitId","");this.getView().setModel(e,"view");this._loadUnits();this._loadMeasurementsList();this._loadConditionsList();this._loadCompanyCodesList();this._loadProjectsList();this._loadBuildingsList();this._loadPaymentPlansForFilter();this._idCounter=parseInt(localStorage.getItem("simulationIdCounter"))||0;this._unitIdCounter=parseInt(localStorage.getItem("unitIdCounter"))||0},_onRouteMatched:function(){this._loadUnits()},_loadUnits:function(){var e=new sap.ui.model.json.JSONModel;fetch("./odata/v4/real-estate/Units?$expand=measurements,conditions").then(e=>e.json()).then(t=>{const n=t.value.map(e=>{let n=e.measurements?.find(e=>e.code?.toUpperCase()==="BUA");let i=n?n.quantity:null;let a=n?n.uom:null;let o=n?n.code:null;let s=e.conditions?.[0];let r=s?s.amount:null;console.log("Units",t.value);console.log("BUA",i);return{...e,bua:i,originalPrice:r,uom:a,measurementCode:o}});e.setData({Units:n});const i=[];const a=[];const o=[];n.forEach(e=>{if(e.unitStatusDescription&&!i.includes(e.unitStatusDescription)){i.push(e.unitStatusDescription)}if(e.unitId&&!a.includes(e.unitId)){a.push(e.unitId)}if(e.unitTypeDescription&&!o.includes(e.unitTypeDescription)){o.push(e.unitTypeDescription)}});console.log("united status",i);console.log("unitIDS",a);console.log("UnitTypes",o);e.setProperty("/UnitStatuses",i.map(e=>({status:e})));e.setProperty("/UnitId",a.map(e=>({id:e})));e.setProperty("/UnitType",o.map(e=>({type:e})));this.getView().setModel(e,"view");this.getView().byId("unitsTable").setModel(e);[]}).catch(e=>{console.error("Error fetching units",e)})},_loadPaymentPlansForFilter:function(){fetch("./odata/v4/real-estate/PaymentPlans?$expand=assignedProjects($expand=project)").then(e=>e.json()).then(e=>{this.getView().setModel(new m(e.value||[]),"paymentPlansFilter");console.log("Payment Plans loaded for filtering:",e.value)}).catch(e=>console.error("Failed to load Payment Plans for filter:",e))},_loadMeasurementsList:function(){fetch("./odata/v4/real-estate/Measurements").then(e=>e.json()).then(e=>{const t=e.value.reduce((e,t)=>{if(!e.find(e=>e.code===t.description)){e.push({code:t.code,description:t.description})}return e},[]);this.getView().setModel(new m(t),"measurementsList");console.log("MeasList",e.value)}).catch(e=>console.error("Failed to load Measurements list:",e))},_loadConditionsList:function(){fetch("./odata/v4/real-estate/Conditions").then(e=>e.json()).then(e=>{this.getView().setModel(new m(e.value||[]),"conditionsList");console.log("CondList",e.value)}).catch(e=>console.error("Failed to load Conditions list:",e))},_loadCompanyCodesList:function(){fetch("./odata/v4/real-estate/Projects").then(e=>e.json()).then(e=>{const t=e.value.reduce((e,t)=>{if(!e.find(e=>e.companyCodeId===t.companyCodeId)){e.push({companyCodeId:t.companyCodeId,companyCodeDescription:t.companyCodeDescription})}return e},[]);this.getView().setModel(new m(t),"companyCodesList");console.log(t)}).catch(e=>console.error("Failed to load Company Codes list:",e))},_loadProjectsList:function(){fetch("./odata/v4/real-estate/Projects").then(e=>e.json()).then(e=>{const t=e.value.reduce((e,t)=>{if(!e.find(e=>e.projectId===t.projectId)){e.push({projectId:t.projectId,projectDescription:t.projectDescription,profitCenter:t.profitCenter,functionalArea:t.functionalArea})}return e},[]);this.getView().setModel(new m(t),"projectsList");console.log("projectsList",e.value)}).catch(e=>console.error("Failed to load Projects list:",e))},_loadBuildingsList:function(){fetch("./odata/v4/real-estate/Buildings").then(e=>e.json()).then(e=>{this.getView().setModel(new m(e.value||[]),"buildingsList")}).catch(e=>console.error("Failed to load Buildings list:",e))},_updateFilteredBuildings:function(e,t){const n=this.getView().getModel("buildingsList").getData();const i=n.filter(t=>t.projectId===e);t.setProperty("/filteredBuildings",i)},onNavigateToAddUnit:function(){if(!this._oAddDialog){var e=new sap.ui.model.json.JSONModel({unitDescription:"",companyCodeId:"",companyCodeDescription:"",projectId:"",projectDescription:"",buildingId:"",unitTypeDescription:"",usageTypeDescription:"",unitStatusDescription:"",floorDescription:"",zone:"",salesPhase:"",finishingSpexDescription:"",profitCenter:"",functionalArea:"",unitDeliveryDate:"",supplementaryText:"",measurements:[],conditions:[],filteredBuildings:[]});this._oAddDialog=new sap.m.Dialog({title:"Add New Unit",content:new sap.m.VBox({items:[new sap.m.Label({text:"Unit Description",required:true}),new sap.m.Input("unitDescInput",{value:"{/unitDescription}",tooltip:"Up to 60 characters"}),new sap.m.Label({text:"Company Code ID",required:true}),new I("companyCodeIdInput",{selectedKey:"{/companyCodeId}",change:this.onCompanyCodeChange.bind(this),items:{path:"companyCodesList>/",template:new D({key:"{companyCodesList>companyCodeId}",text:"{companyCodesList>companyCodeId} - {companyCodesList>companyCodeDescription}"})},tooltip:"Must be 4 characters"}),new sap.m.Label({text:"Company Code Description",required:true}),new sap.m.Input("companyCodeDescInput",{value:"{/companyCodeDescription}",tooltip:"Up to 60 characters"}),new sap.m.Label({text:"Project ID",required:true}),new I("projectIdInput",{selectedKey:"{/projectId}",change:this.onProjectChange.bind(this),items:{path:"projectsList>/",template:new D({key:"{projectsList>projectId}",text:"{projectsList>projectId} - {projectsList>projectDescription}"})},tooltip:"Must be 8 characters"}),new sap.m.Label({text:"Project Description",required:true}),new sap.m.Input("projectDescInput",{value:"{/projectDescription}",tooltip:"Up to 60 characters"}),new sap.m.Label({text:"Unit Type Description",required:true}),new sap.m.Input("unitTypeDescInput",{value:"{/unitTypeDescription}"}),new sap.m.Label({text:"Usage Type Description",required:true}),new sap.m.Input("usageTypeDescInput",{value:"{/usageTypeDescription}"}),new sap.m.Label({text:"Unit Status Description",required:true}),new sap.m.Input("unitStatusDescInput",{value:"{/unitStatusDescription}"}),new sap.m.Label({text:"Floor Description",required:true}),new sap.m.Input("floorDescInput",{value:"{/floorDescription}"}),new sap.m.Label({text:"Zone",required:true}),new sap.m.Input("zoneInput",{value:"{/zone}"}),new sap.m.Label({text:"Sales Phase",required:true}),new sap.m.Input("salesPhaseInput",{value:"{/salesPhase}"}),new sap.m.Label({text:"Finishing Spex Description",required:true}),new sap.m.Input("finishingSpexDescInput",{value:"{/finishingSpexDescription}"}),new sap.m.Label({text:"Profit Center"}),new sap.m.Text({text:"{/profitCenter}"}),new sap.m.Label({text:"Functional Area"}),new sap.m.Text({text:"{/functionalArea}"}),new sap.m.Label({text:"Delivery Date",required:true}),new sap.m.DatePicker("unitDeliveryDateInput",{value:"{/unitDeliveryDate}",displayFormat:"long",valueFormat:"yyyy-MM-dd",placeholder:"Select a date"}),new sap.m.Label({text:"Supplementary Text",required:true}),new sap.m.Input("supplementaryTextInput",{value:"{/supplementaryText}"}),new sap.m.Title({text:"Measurements",level:"H3"}),new sap.m.Button({text:"Add Measurement",press:this.onAddMeasurementRow.bind(this)}),new sap.m.Button({text:"Delete Measurement",press:this.onDeleteMeasurementRow.bind(this)}),new sap.m.Table({id:"addMeasurementsTable",items:"{/measurements}",columns:[new sap.m.Column({header:new sap.m.Label({text:"Code"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Label({text:"UOM"})})],items:{path:"/measurements",template:new sap.m.ColumnListItem({cells:[new I({selectedKey:"{code}",change:this.onMeasurementCodeChange.bind(this),items:{path:"measurementsList>/",template:new D({key:"{measurementsList>code}",text:"{measurementsList>code} - {measurementsList>description}"})}}),new s({text:"{description}"}),new i({value:"{quantity}",type:"Number"}),new i({value:"{uom}"})]})}}),new sap.m.Title({text:"Conditions",level:"H3"}),new sap.m.Button({text:"Add Condition",press:this.onAddConditionRow.bind(this)}),new sap.m.Button({text:"Delete Condition",press:this.onDeleteConditionRow.bind(this)}),new sap.m.Table({id:"addConditionsTable",items:"{/conditions}",columns:[new sap.m.Column({header:new sap.m.Label({text:"Code"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"Amount"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})}),new sap.m.Column({header:new sap.m.Label({text:"Number of Years"})})],items:{path:"/conditions",template:new sap.m.ColumnListItem({cells:[new I({selectedKey:"{code}",change:this.onConditionCodeChange.bind(this),items:{path:"conditionsList>/",template:new D({key:"{conditionsList>code}",text:"{conditionsList>code} - {conditionsList>description}"})}}),new s({text:"{description}"}),new i({value:"{amount}",type:"Number"}),new i({value:"{currency}"}),new i({value:"{numberOfYears}",type:"Number"})]})}})]}),beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:function(){var e=this._oAddDialog.getModel().getData();var t=[{id:"unitDescInput",name:"Unit Description"},{id:"companyCodeIdInput",name:"Company Code ID"},{id:"companyCodeDescInput",name:"Company Code Description"},{id:"projectIdInput",name:"Project ID"},{id:"projectDescInput",name:"Project Description"},{id:"unitTypeDescInput",name:"Unit Type Description"},{id:"usageTypeDescInput",name:"Usage Type Description"},{id:"unitStatusDescInput",name:"Unit Status Description"},{id:"floorDescInput",name:"Floor Description"},{id:"zoneInput",name:"Zone"},{id:"salesPhaseInput",name:"Sales Phase"},{id:"finishingSpexDescInput",name:"Finishing Spex Description"},{id:"unitDeliveryDateInput",name:"Delivery Date"},{id:"supplementaryTextInput",name:"Supplementary Text"}];var n=true;t.forEach(function(e){var t=sap.ui.getCore().byId(e.id);if(!t.getValue()){t.setValueState("Error");t.setValueStateText(e.name+" is required");n=false}else{t.setValueState("None")}});if(!n){sap.m.MessageBox.warning("Please fill all required fields before saving.");return}this._unitIdCounter=(this._unitIdCounter||0)+1;const i="U"+("000"+this._unitIdCounter).slice(-4);localStorage.setItem("unitIdCounter",this._unitIdCounter);const a={unitId:i,unitDescription:e.unitDescription,companyCodeId:e.companyCodeId,companyCodeDescription:e.companyCodeDescription,projectId:e.projectId,projectDescription:e.projectDescription,unitTypeDescription:e.unitTypeDescription,usageTypeDescription:e.usageTypeDescription,unitStatusDescription:e.unitStatusDescription,floorDescription:e.floorDescription,zone:e.zone,salesPhase:e.salesPhase,finishingSpexDescription:e.finishingSpexDescription,unitDeliveryDate:e.unitDeliveryDate||null,supplementaryText:e.supplementaryText,profitCenter:e.profitCenter||0,functionalArea:e.functionalArea||0,measurements:e.measurements,conditions:e.conditions};if(a.measurements.length===0){delete a.measurements}if(a.conditions.length===0){delete a.conditions}fetch("./odata/v4/real-estate/Units",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>{if(!e.ok){throw new Error("Failed to create unit")}return e.json()}).then(()=>{sap.m.MessageToast.show("Unit created!");this._loadUnits();this._resetAddDialogFields();this._oAddDialog.close()}).catch(e=>{sap.m.MessageBox.error("Error: "+e.message)})}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._resetAddDialogFields();this._oAddDialog.close()}.bind(this)})});this._oAddDialog.setModel(e);this.getView().addDependent(this._oAddDialog)}this._resetAddDialogFields();this._oAddDialog.open()},_resetAddDialogFields:function(){var e=this._oAddDialog.getModel();e.setData({unitDescription:"",companyCodeId:"",companyCodeDescription:"",projectId:"",projectDescription:"",unitTypeDescription:"",usageTypeDescription:"",unitStatusDescription:"",floorDescription:"",zone:"",salesPhase:"",finishingSpexDescription:"",profitCenter:"",functionalArea:"",unitDeliveryDate:"",supplementaryText:"",measurements:[],conditions:[],filteredBuildings:[]});["unitDescInput","companyCodeIdInput","companyCodeDescInput","projectIdInput","projectDescInput","buildingIdInput","unitTypeDescInput","usageTypeDescInput","unitStatusDescInput","floorDescInput","zoneInput","salesPhaseInput","finishingSpexDescInput","unitDeliveryDateInput","supplementaryTextInput"].forEach(function(e){var t=sap.ui.getCore().byId(e);if(t)t.setValueState("None")})},onDetails:function(e){var t=e.getSource().getBindingContext();if(!t){return}var n=t.getObject();var i=new sap.ui.model.json.JSONModel({unitId:n.unitId,unitDescription:n.unitDescription,companyCodeId:n.companyCodeId,companyCodeDescription:n.companyCodeDescription,projectId:n.projectId,projectDescription:n.projectDescription,buildingId:n.buildingId,unitTypeDescription:n.unitTypeDescription,usageTypeDescription:n.usageTypeDescription,unitStatusDescription:n.unitStatusDescription,floorDescription:n.floorDescription,zone:n.zone,salesPhase:n.salesPhase,finishingSpexDescription:n.finishingSpexDescription,profitCenter:n.profitCenter,functionalArea:n.functionalArea,unitDeliveryDate:n.unitDeliveryDate,supplementaryText:n.supplementaryText,measurements:n.measurements,conditions:n.conditions});if(!this._oDetailsDialog){this._oDetailsDialog=new sap.m.Dialog({title:"Unit Details",contentWidth:"100%",resizable:true,draggable:true,content:[new sap.m.IconTabBar({expandable:true,items:[new sap.m.IconTabFilter({text:"General Data",icon:"sap-icon://project-definition",content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",labelSpanL:3,columnsL:2,content:[new sap.m.Label({text:"Unit ID"}),new sap.m.Text({text:"{/unitId}"}),new sap.m.Label({text:"Unit Description"}),new sap.m.Text({text:"{/unitDescription}"}),new sap.m.Label({text:"Company Code ID"}),new sap.m.Text({text:"{/companyCodeId}"}),new sap.m.Label({text:"Company Code Description"}),new sap.m.Text({text:"{/companyCodeDescription}"}),new sap.m.Label({text:"Project ID"}),new sap.m.Text({text:"{/projectId}"}),new sap.m.Label({text:"Project Description"}),new sap.m.Text({text:"{/projectDescription}"}),new sap.m.Label({text:"Building ID"}),new sap.m.Text({text:"{/buildingId}"}),new sap.m.Label({text:"Unit Type Description"}),new sap.m.Text({text:"{/unitTypeDescription}"}),new sap.m.Label({text:"Usage Type Description"}),new sap.m.Text({text:"{/usageTypeDescription}"}),new sap.m.Label({text:"Unit Status Description"}),new sap.m.Text({text:"{/unitStatusDescription}"}),new sap.m.Label({text:"Floor Description"}),new sap.m.Text({text:"{/floorDescription}"}),new sap.m.Label({text:"Zone"}),new sap.m.Text({text:"{/zone}"}),new sap.m.Label({text:"Sales Phase"}),new sap.m.Text({text:"{/salesPhase}"}),new sap.m.Label({text:"Finishing Spex Description"}),new sap.m.Text({text:"{/finishingSpexDescription}"}),new sap.m.Label({text:"Delivery Date"}),new sap.m.Text({text:"{/unitDeliveryDate}"})]})]}),new sap.m.IconTabFilter({text:"Posting Parameters",icon:"sap-icon://post",content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",labelSpanL:3,columnsL:2,content:[new sap.m.Label({text:"Profit Center"}),new sap.m.Text({text:"{/profitCenter}"}),new sap.m.Label({text:"Functional Area"}),new sap.m.Text({text:"{/functionalArea}"})]})]}),new sap.m.IconTabFilter({text:"Supplementary Text",icon:"sap-icon://document-text",content:[new sap.ui.layout.form.SimpleForm({editable:false,layout:"ResponsiveGridLayout",content:[new sap.m.Label({text:"Supplementary Text"}),new sap.m.TextArea({value:"{/supplementaryText}",width:"100%",rows:6,editable:false,growing:true,growingMaxLines:10})]})]}),new sap.m.IconTabFilter({text:"Measurements",icon:"sap-icon://measure",content:[new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:"Code"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Label({text:"UOM"})})],items:{path:"/measurements",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{code}"}),new sap.m.Text({text:"{description}"}),new sap.m.Text({text:"{quantity}"}),new sap.m.Text({text:"{uom}"})]})}})]}),new sap.m.IconTabFilter({text:"Conditions",icon:"sap-icon://list",content:[new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:"Code"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"Amount"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})}),new sap.m.Column({header:new sap.m.Label({text:"Number of Years"})})],items:{path:"/conditions",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{code}"}),new sap.m.Text({text:"{description}"}),new sap.m.Text({text:"{amount}"}),new sap.m.Text({text:"{currency}"}),new sap.m.Text({text:"{numberOfYears}"})]})}})]})]})],endButton:new sap.m.Button({text:"Close",type:"Emphasized",press:function(){this._oDetailsDialog.close()}.bind(this)})});this.getView().addDependent(this._oDetailsDialog)}this._oDetailsDialog.setModel(i);this._oDetailsDialog.open()},onDelete:function(e){var n=e.getSource().getBindingContext();if(n){var i=n.getPath();var a=this.getView().byId("unitsTable").getModel();var o=a.getProperty(i);if(!o){sap.m.MessageBox.error("Could not find model data for deletion.");return}t.confirm("Are you sure you want to delete "+o.unitId+"?",{title:"Confirm Deletion",onClose:function(e){if(e===t.Action.OK){fetch(`./odata/v4/real-estate/Units(unitId='${o.unitId}')`,{method:"DELETE"}).then(e=>{if(!e.ok){throw new Error("Failed to delete: "+e.statusText)}var t=a.getProperty("/Units");var n=t.findIndex(e=>e.unitId===o.unitId);if(n>-1){t.splice(n,1);a.setProperty("/Units",t)}sap.m.MessageToast.show("Unit deleted successfully!")}).catch(e=>{console.error("Error deleting Unit:",e);sap.m.MessageBox.error("Error: "+e.message)})}}})}},onEditUnit:function(e){var t=e.getSource().getBindingContext();if(!t)return;var n=t.getObject();var a=new sap.ui.model.json.JSONModel(Object.assign({},n,{filteredBuildings:[]}));this._updateFilteredBuildings(n.projectId,a);if(!this._oEditDialog){this._oEditDialog=new sap.m.Dialog({title:"Edit Unit",content:new sap.m.VBox({items:[new sap.m.Label({text:"Unit ID"}),new sap.m.Input({value:"{/unitId}",editable:false}),new sap.m.Label({text:"Unit Description",required:true}),new sap.m.Input("editUnitDescInput",{value:"{/unitDescription}"}),new sap.m.Label({text:"Company Code ID",required:true}),new I("editCompanyCodeIdInput",{selectedKey:"{/companyCodeId}",change:this.onCompanyCodeChange.bind(this),items:{path:"companyCodesList>/",template:new D({key:"{companyCodesList>companyCodeId}",text:"{companyCodesList>companyCodeId} - {companyCodesList>companyCodeDescription}"})}}),new sap.m.Label({text:"Company Code Description",required:true}),new sap.m.Input("editCompanyCodeDescInput",{value:"{/companyCodeDescription}"}),new sap.m.Label({text:"Project ID",required:true}),new I("editProjectIdInput",{selectedKey:"{/projectId}",change:this.onProjectChange.bind(this),items:{path:"projectsList>/",template:new D({key:"{projectsList>projectId}",text:"{projectsList>projectId} - {projectsList>projectDescription}"})}}),new sap.m.Label({text:"Project Description",required:true}),new sap.m.Input("editProjectDescInput",{value:"{/projectDescription}"}),new sap.m.Label({text:"Unit Type Description",required:true}),new sap.m.Input("editUnitTypeDescInput",{value:"{/unitTypeDescription}"}),new sap.m.Label({text:"Usage Type Description",required:true}),new sap.m.Input("editUsageTypeDescInput",{value:"{/usageTypeDescription}"}),new sap.m.Label({text:"Unit Status Description",required:true}),new sap.m.Input("editUnitStatusDescInput",{value:"{/unitStatusDescription}"}),new sap.m.Label({text:"Floor Description",required:true}),new sap.m.Input("editFloorDescInput",{value:"{/floorDescription}"}),new sap.m.Label({text:"Zone",required:true}),new sap.m.Input("editZoneInput",{value:"{/zone}"}),new sap.m.Label({text:"Sales Phase",required:true}),new sap.m.Input("editSalesPhaseInput",{value:"{/salesPhase}"}),new sap.m.Label({text:"Finishing Spex Description",required:true}),new sap.m.Input("editFinishingSpexDescInput",{value:"{/finishingSpexDescription}"}),new sap.m.Label({text:"Profit Center",required:true}),new sap.m.Input("editProfitCenterInput",{value:"{/profitCenter}"}),new sap.m.Label({text:"Functional Area",required:true}),new sap.m.Input("editFunctionalAreaInput",{value:"{/functionalArea}"}),new sap.m.Label({text:"Delivery Date",required:true}),new sap.m.DatePicker("editUnitDeliveryDateInput",{value:"{/unitDeliveryDate}",displayFormat:"long",valueFormat:"yyyy-MM-dd",placeholder:"Select a date"}),new sap.m.Label({text:"Supplementary Text",required:true}),new sap.m.Input("editSupplementaryTextInput",{value:"{/supplementaryText}"}),new sap.m.Title({text:"Measurements",level:"H3"}),new sap.m.Button({text:"Add Measurement",press:this.onAddMeasurementRow.bind(this)}),new sap.m.Button({text:"Delete Measurement",press:this.onDeleteMeasurementRow.bind(this)}),new sap.m.Table({id:"editMeasurementsTable",items:"{/measurements}",columns:[new sap.m.Column({header:new sap.m.Label({text:"Code"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"Quantity"})}),new sap.m.Column({header:new sap.m.Label({text:"UOM"})})],items:{path:"/measurements",template:new sap.m.ColumnListItem({cells:[new I({selectedKey:"{code}",change:this.onMeasurementCodeChange.bind(this),items:{path:"measurementsList>/",template:new D({key:"{measurementsList>code}",text:"{measurementsList>code} - {measurementsList>description}"})}}),new s({text:"{description}"}),new i({value:"{quantity}",type:"Number"}),new i({value:"{uom}"})]})}}),new sap.m.Title({text:"Conditions",level:"H3"}),new sap.m.Button({text:"Add Condition",press:this.onAddConditionRow.bind(this)}),new sap.m.Button({text:"Delete Condition",press:this.onDeleteConditionRow.bind(this)}),new sap.m.Table({id:"editConditionsTable",items:"{/conditions}",columns:[new sap.m.Column({header:new sap.m.Label({text:"Code"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})}),new sap.m.Column({header:new sap.m.Label({text:"Amount"})}),new sap.m.Column({header:new sap.m.Label({text:"Currency"})})],items:{path:"/conditions",template:new sap.m.ColumnListItem({cells:[new I({selectedKey:"{code}",change:this.onConditionCodeChange.bind(this),items:{path:"conditionsList>/",template:new D({key:"{conditionsList>code}",text:"{conditionsList>code} - {conditionsList>description}"})}}),new s({text:"{description}"}),new i({value:"{amount}",type:"Number"}),new i({value:"{currency}"})]})}})]}),beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:function(){var e=this._oEditDialog.getModel().getData();var t=[{id:"editUnitDescInput",name:"Unit Description"},{id:"editCompanyCodeIdInput",name:"Company Code ID"},{id:"editCompanyCodeDescInput",name:"Company Code Description"},{id:"editProjectIdInput",name:"Project ID"},{id:"editProjectDescInput",name:"Project Description"},{id:"editUnitTypeDescInput",name:"Unit Type Description"},{id:"editUsageTypeDescInput",name:"Usage Type Description"},{id:"editUnitStatusDescInput",name:"Unit Status Description"},{id:"editFloorDescInput",name:"Floor Description"},{id:"editZoneInput",name:"Zone"},{id:"editSalesPhaseInput",name:"Sales Phase"},{id:"editFinishingSpexDescInput",name:"Finishing Spex Description"},{id:"editProfitCenterInput",name:"Profit Center"},{id:"editFunctionalAreaInput",name:"Functional Area"},{id:"editUnitDeliveryDateInput",name:"Delivery Date"},{id:"editSupplementaryTextInput",name:"Supplementary Text"}];var n=true;t.forEach(function(e){var t=sap.ui.getCore().byId(e.id);if(!t.getValue()){t.setValueState("Error");t.setValueStateText(e.name+" is required");n=false}else{t.setValueState("None")}});if(!n){sap.m.MessageBox.warning("Please fill all required fields before saving.");return}const i={unitId:e.unitId,unitDescription:e.unitDescription,companyCodeId:e.companyCodeId,companyCodeDescription:e.companyCodeDescription,projectId:e.projectId,projectDescription:e.projectDescription,unitTypeDescription:e.unitTypeDescription,usageTypeDescription:e.usageTypeDescription,unitStatusDescription:e.unitStatusDescription,floorDescription:e.floorDescription,zone:e.zone,salesPhase:e.salesPhase,finishingSpexDescription:e.finishingSpexDescription,unitDeliveryDate:e.unitDeliveryDate||null,supplementaryText:e.supplementaryText,profitCenter:e.profitCenter||0,functionalArea:e.functionalArea||0,measurements:e.measurements,conditions:e.conditions};if(i.measurements.length===0){delete i.measurements}if(i.conditions.length===0){delete i.conditions}fetch(`./odata/v4/real-estate/Units(unitId='${e.unitId}')`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(e=>{if(!e.ok)throw new Error("Update failed");return e.json()}).then(()=>{sap.m.MessageToast.show("Unit updated successfully!");this._loadUnits();this._oEditDialog.close()}).catch(e=>sap.m.MessageBox.error("Error: "+e.message))}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._oEditDialog.close()}.bind(this)})});this.getView().addDependent(this._oEditDialog)}this._oEditDialog.setModel(a);this._oEditDialog.open()},onCompanyCodeChange:function(e){var t=e.getSource();var n=t.getSelectedKey();var i=t.getSelectedItem();var a=i?i.getText().split(" - ")[1]||"":"";var o=t.getBindingContext();if(o){o.getModel().setProperty(o.getPath()+"/companyCodeDescription",a)}else{t.getModel().setProperty("/companyCodeDescription",a)}},onProjectChange:function(e){var t=e.getSource();var n=t.getSelectedKey();var i=t.getSelectedItem();var a=i?i.getText().split(" - ")[1]||"":"";var o=t.getModel();o.setProperty("/projectDescription",a);const s=this.getView().getModel("projectsList").getData();const r=s.find(e=>e.projectId===n);if(r){o.setProperty("/profitCenter",r.profitCenter);o.setProperty("/functionalArea",r.functionalArea)}this._updateFilteredBuildings(n,o)},onAddMeasurementRow:function(e){const t=e.getSource().getModel();t.getProperty("/measurements").push({code:"",description:"",quantity:0,uom:""});t.refresh()},onDeleteMeasurementRow:function(e){const t=e.getSource().getModel();const n=t.getProperty("/measurements");n.pop();t.refresh()},onAddConditionRow:function(e){const t=e.getSource().getModel();t.getProperty("/conditions").push({code:"",description:"",amount:0,currency:"",numberOfYears:0});t.refresh()},onDeleteConditionRow:function(e){const t=e.getSource().getModel();const n=t.getProperty("/conditions");n.pop();t.refresh()},onMeasurementCodeChange:function(e){var t=e.getSource();var n=t.getSelectedKey();var i=t.getSelectedItem();var a=i?i.getText().split(" - ")[1]||"":"";var o=t.getBindingContext();if(o){o.getModel().setProperty(o.getPath()+"/description",a)}},onConditionCodeChange:function(e){var t=e.getSource();var n=t.getSelectedKey();var i=t.getSelectedItem();var a=i?i.getText().split(" - ")[1]||"":"";var o=t.getBindingContext();if(o){o.getModel().setProperty(o.getPath()+"/description",a)}},onFilterUnits:function(){var e=this.byId("unitsTable");var t=e.getBinding("items");var n=[];var i=this.byId("unitTypeFilter").getSelectedKey();if(i){n.push(new sap.ui.model.Filter("unitTypeDescription",sap.ui.model.FilterOperator.EQ,i))}var a=this.byId("companyCodeFilter").getSelectedKey();if(a){n.push(new sap.ui.model.Filter("companyCodeId",sap.ui.model.FilterOperator.EQ,a))}var o=this.byId("projectIdFilter").getSelectedKey();if(o){n.push(new sap.ui.model.Filter("projectId",sap.ui.model.FilterOperator.EQ,o))}var s=this.byId("_IDGenInput17").getValue();var r=this.byId("_IDGenInput18").getValue();if(s)n.push(new sap.ui.model.Filter("floorDescription",sap.ui.model.FilterOperator.GE,s));if(r)n.push(new sap.ui.model.Filter("floorDescription",sap.ui.model.FilterOperator.LE,r));var l=this.byId("measurementFilter").getSelectedKey();var p=this.byId("_IDGenInput15").getValue();var u=this.byId("_IDGenInput16").getValue();var c=this.byId("_IDGenInput19").getValue();if(l||p||u||c){n.push(new sap.ui.model.Filter({path:"",test:function(e){var t=e.measurements?.find(e=>e.code?.toUpperCase()===l?.toUpperCase());if(l&&!t)return false;if((p||u||c)&&!t)return false;if(p&&parseFloat(t.quantity)<parseFloat(p))return false;if(u&&parseFloat(t.quantity)>parseFloat(u))return false;if(c&&t.uom?.toUpperCase()!==c.toUpperCase())return false;return true}}))}var d=this.byId("_IDGenInput20").getValue();var m=this.byId("_IDGenInput21").getValue().trim().toUpperCase();if(d||m){var g=[];var h=this.getView().getModel("paymentPlansFilter").getData()||[];h.forEach(function(e){var t=!d||e.planYears===parseInt(d);var n=!m||e.currency&&e.currency.toUpperCase()===m;if(t&&n){if(Array.isArray(e.assignedProjects)){e.assignedProjects.forEach(function(e){if(e.project&&e.project.projectId){var t=e.project.projectId;if(g.indexOf(t)===-1){g.push(t)}}})}}});if(g.length>0){var P=g.map(function(e){return new sap.ui.model.Filter("projectId",sap.ui.model.FilterOperator.EQ,e)});n.push(new sap.ui.model.Filter({aFilters:P,bAnd:false}))}else{n.push(new sap.ui.model.Filter("projectId",sap.ui.model.FilterOperator.EQ,null))}}var y=n.length>0?new sap.ui.model.Filter(n,true):null;t.filter(y?[y]:[])},onCreateReservation:function(e){var t=e.getSource().getBindingContext().getObject();var n=sap.ui.core.UIComponent.getRouterFor(this);n.navTo("Reservations",{unitId:t.unitId})},onClearFilter:function(){var e=this.getView().getModel("view");this.byId("unitTypeFilter").setSelectedKey("");this.byId("companyCodeFilter").setSelectedKey("");this.byId("projectIdFilter").setSelectedKey("");e.setProperty("/selectedUnitStatus","");e.setProperty("/selectedUnitId","");e.setProperty("/selectedUnitId","");var t=this.byId("unitsTable");t.getBinding("items").filter([])},onOpenPaymentSimulation:function(e){var t=e.getSource().getBindingContext().getObject().unitId;if(!this._oSimulationDialog){var n=new sap.m.VBox({items:[new sap.m.Title({text:"Simulation Details",level:"H3"}),new sap.m.Label({text:"Simulation ID"}),new sap.m.Input({id:"simIdInput",value:"{local>/simulationId}",editable:false,placeholder:"Auto-generated"}),new sap.m.Label({text:"Unit"}),new sap.m.Input({id:"unitIdInputPPS",value:"{local>/unitDisplay}",showValueHelp:true,valueHelpRequest:this.onOpenUnitValueHelpPPS.bind(this),editable:false,placeholder:"Unit pre-selected"}),new sap.m.Label({text:"Project ID"}),new sap.m.Input({id:"projectIdInputPPS",value:"{local>/projectId}",editable:false}),new sap.m.Label({text:"Project Description"}),new sap.m.Input({id:"projectDescriptionInputPPS",value:"{local>/projectDescription}",editable:false}),new sap.m.Label({text:"Price Plan (Years)"}),new sap.m.Input({id:"pricePlanInputPPS",value:"{local>/pricePlanYears}",editable:false,placeholder:"Auto-calculated from unit conditions"}),new sap.m.Label({text:"Payment Plan ID"}),new sap.m.Input({id:"paymentPlanIdInputPPS",value:"{local>/paymentPlanId}",editable:false}),new sap.m.Label({text:"Lead ID"}),new sap.m.Input({id:"leadIdInputPPS",value:"{local>/leadId}",placeholder:"Enter code"}),new sap.m.Label({text:"Final Price"}),new sap.m.Input({id:"finalPriceInputPPS",value:"{local>/finalPrice}",editable:false}),new sap.m.Label({text:"User"}),new sap.m.Input({id:"userIdInputPPS",value:"currentUser",editable:false}),new sap.m.HBox({items:[new sap.m.Button({id:"saveBtnPPS",text:"Save Simulation",press:this.onSaveSimulationPPS.bind(this)})]}),new sap.m.Title({text:"Payment Schedule",level:"H3"}),new sap.m.Table({id:"simulationTablePPS",items:"{simulationOutput>/}",width:"100%",showSeparators:"All",columns:[new sap.m.Column({header:new sap.m.Label({text:"Condition Type"})}),new sap.m.Column({header:new sap.m.Label({text:"Due Date"})}),new sap.m.Column({header:new sap.m.Label({text:"Amount"})}),new sap.m.Column({header:new sap.m.Label({text:"Maintenance"})})],items:{path:"simulationOutput>/",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{simulationOutput>conditionType}"}),new sap.m.Text({text:"{simulationOutput>dueDate}"}),new sap.m.Text({text:"{simulationOutput>amount}"}),new sap.m.Text({text:"{simulationOutput>maintenance}"})]})}})]});this._oSimulationDialog=new sap.m.Dialog({title:"Payment Plan Simulation",contentWidth:"80%",resizable:true,content:n,endButton:new sap.m.Button({text:"Close",press:function(){this._oSimulationDialog.close()}.bind(this)})});this._oSimulationDialog.setModel(new m({}),"local");this._oSimulationDialog.setModel(new m([]),"simulationOutput");this._loadUnitsForSim();this._loadDropdownDataForSim();this.getView().addDependent(this._oSimulationDialog)}if(this._oSimulationDialog){var i=this._oSimulationDialog.getModel("local");i.setProperty("/unitId",t);var a=this.getView().getModel("view").getProperty("/Units");var o=a.find(e=>e.unitId===t);if(o){i.setProperty("/projectId",o.projectId);i.setProperty("/projectDescription",o.projectDescription);sap.ui.getCore().byId("unitIdInputPPS").setValue(`${o.unitDescription} (${t})`);this._calculateFinalPricePPS(t,i);const e=o.conditions||[];const n=e.reduce((e,t)=>e+(t.numberOfYears||0),0);i.setProperty("/pricePlanYears",n);this.onOpenPricePlanValueHelpPPS()}this._oSimulationDialog.open()}else{console.error("Simulation dialog could not be created.")}},onOpenPricePlanValueHelpPPS:function(){const e=this._oSimulationDialog;const t=sap.ui.getCore().byId("projectIdInputPPS").getValue();const n=this._oSimulationDialog.getModel("local").getProperty("/pricePlanYears");console.log("Opening Price Plan Value Help for projectId:",t,"and years:",n);if(!this._oPricePlanValueHelpPPS){this._oPricePlanValueHelpPPS=new f({title:"Select Payment Plan (Filtered by Unit Conditions Years)",items:{path:"filteredPlans>/",template:new C({title:"{filteredPlans>planYears} Years",description:"{filteredPlans>description}"})},search:function(e){const t=e.getParameter("value")||"";const n=[new sap.ui.model.Filter("planYears",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,t)];e.getSource().getBinding("items").filter(new sap.ui.model.Filter(n,false))},confirm:function(e){const t=e.getParameter("selectedItem");if(t){const e=t.getBindingContext("filteredPlans");const n=e.getObject();const i=n.planYears;const a=n.paymentPlanId;const o=n.description||"";console.log("Selected plan:",n);sap.ui.getCore().byId("paymentPlanIdInputPPS").setValue(a);this.onSimulatePPS()}}.bind(this)});e.addDependent(this._oPricePlanValueHelpPPS)}const i=this._oSimulationDialog.getModel("paymentPlans");const a=i?i.getData():[];console.log("All payment plans:",a);const o=a.filter(e=>Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===t)&&e.planYears===n);console.log("Filtered plans for project and years:",o);if(o.length===0){sap.m.MessageBox.warning(`No payment plans available for the selected project with ${n} years from unit conditions.`);return}this._oPricePlanValueHelpPPS.setModel(new m(o),"filteredPlans");const s=this._oPricePlanValueHelpPPS.getBinding("items");if(s){s.refresh()}this._oPricePlanValueHelpPPS.open()},onOpenPricePlanValueHelpPPS:function(){const e=this._oSimulationDialog;const t=sap.ui.getCore().byId("projectIdInputPPS").getValue();const n=this._oSimulationDialog.getModel("local").getProperty("/pricePlanYears");console.log("Opening Price Plan Value Help for projectId:",t,"and years:",n);if(!this._oPricePlanValueHelpPPS){this._oPricePlanValueHelpPPS=new f({title:"Select Payment Plan (Filtered by Unit Conditions Years)",items:{path:"filteredPlans>/",template:new C({title:"{filteredPlans>planYears} Years",description:"{filteredPlans>description}"})},search:function(e){const t=e.getParameter("value")||"";const n=[new sap.ui.model.Filter("planYears",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,t)];e.getSource().getBinding("items").filter(new sap.ui.model.Filter(n,false))},confirm:function(e){const t=e.getParameter("selectedItem");if(t){const e=t.getBindingContext("filteredPlans");const n=e.getObject();const i=n.planYears;const a=n.paymentPlanId;const o=n.description||"";console.log("Selected plan:",n);sap.ui.getCore().byId("paymentPlanIdInputPPS").setValue(a);this.onSimulatePPS()}}.bind(this)});e.addDependent(this._oPricePlanValueHelpPPS)}const i=this._oSimulationDialog.getModel("paymentPlans");const a=i?i.getData():[];console.log("All payment plans:",a);const o=a.filter(e=>Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===t)&&e.planYears===n);console.log("Filtered plans for project and years:",o);if(o.length===0){sap.m.MessageBox.warning(`No payment plans available for the selected project with ${n} years from unit conditions.`);return}this._oPricePlanValueHelpPPS.setModel(new m(o),"filteredPlans");const s=this._oPricePlanValueHelpPPS.getBinding("items");if(s){s.refresh()}this._oPricePlanValueHelpPPS.open()},onOpenPricePlanValueHelpPPS:function(){const e=this._oSimulationDialog;const t=sap.ui.getCore().byId("projectIdInputPPS").getValue();console.log("Opening Price Plan Value Help for projectId:",t);if(!this._oPricePlanValueHelpPPS){this._oPricePlanValueHelpPPS=new f({title:"Select Payment Plan Year",items:{path:"filteredPlans>/",template:new C({title:"{filteredPlans>planYears} Years",description:"{filteredPlans>description}"})},search:function(e){const t=e.getParameter("value")||"";const n=[new sap.ui.model.Filter("planYears",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,t)];e.getSource().getBinding("items").filter(new sap.ui.model.Filter(n,false))},confirm:function(e){const t=e.getParameter("selectedItem");if(t){const e=t.getBindingContext("filteredPlans");const n=e.getObject();const i=n.planYears;const a=n.paymentPlanId;const o=n.description||"";console.log("Selected plan:",n);sap.ui.getCore().byId("pricePlanInputPPS").setValue(`${i} Years`);sap.ui.getCore().byId("paymentPlanIdInputPPS").setValue(a);this.onSimulatePPS()}}.bind(this)});e.addDependent(this._oPricePlanValueHelpPPS)}const n=this._oSimulationDialog.getModel("paymentPlans");const i=n?n.getData():[];console.log("All payment plans:",i);const a=i.filter(e=>Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===t));console.log("Filtered plans for project:",a);if(a.length===0){sap.m.MessageBox.warning("No payment plans available for the selected project.");return}this._oPricePlanValueHelpPPS.setModel(new m(a),"filteredPlans");const o=this._oPricePlanValueHelpPPS.getBinding("items");if(o){o.refresh()}this._oPricePlanValueHelpPPS.open()},onPricePlanChangePPS:function(e){const n=parseInt(e.getParameter("value"));const i=sap.ui.getCore().byId("projectIdInputPPS").getValue();const a=this._oSimulationDialog.getModel("paymentPlans");const o=a?a.getData():[];const s=(o||[]).find(e=>e.planYears===n&&Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===i));if(s){sap.ui.getCore().byId("paymentPlanIdInputPPS").setValue(s.paymentPlanId);this.onSimulatePPS()}else{sap.ui.getCore().byId("paymentPlanIdInputPPS").setValue("");t.warning("No payment plan found for the entered years and project. Please select from the value help.")}},_loadUnitsForSim:function(){fetch("./odata/v4/real-estate/Units?$expand=project").then(e=>e.json()).then(e=>{this._oSimulationDialog.setModel(new m(e.value||[]),"units")}).catch(e=>console.error("Failed to load units for PPS:",e))},_loadDropdownDataForSim:async function(){try{const[e,t]=await Promise.all([fetch("./odata/v4/real-estate/Projects"),fetch("./odata/v4/real-estate/PaymentPlans?$expand=assignedProjects($expand=project)")]);const n=await e.json();const i=await t.json();this._oSimulationDialog.setModel(new m(n.value||[]),"projects");this._oSimulationDialog.setModel(new m(i.value||[]),"paymentPlans")}catch(e){console.error("Failed to load dropdown data for PPS:",e)}},onOpenUnitValueHelpPPS:function(){const e=this._oSimulationDialog;if(!this._oUnitValueHelpPPS){this._oUnitValueHelpPPS=new f({title:"Select Unit",items:{path:"units>/",template:new C({title:"{units>unitDescription}",description:"{units>unitId}"})},search:function(e){const t=e.getParameter("value")||"";const n=[new sap.ui.model.Filter("unitDescription",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("unitId",sap.ui.model.FilterOperator.Contains,t)];e.getSource().getBinding("items").filter(new sap.ui.model.Filter(n,false))},confirm:function(t){const n=t.getParameter("selectedItem");if(n){const t=n.getBindingContext("units");const i=t.getObject();const a=i.unitId;const o=i.unitDescription;const s=e.getModel("local");s.setProperty("/unitId",a);sap.ui.getCore().byId("unitIdInputPPS").setValue(`${o} (${a})`);this._onUnitSelectedPPS(a)}}.bind(this)});e.addDependent(this._oUnitValueHelpPPS)}this._oUnitValueHelpPPS.open()},_onUnitSelectedPPS:function(e){this.onUnitChangePPS({getParameter:()=>({selectedItem:{getKey:()=>e}})})},onUnitChangePPS:async function(e){let t=null;if(e&&typeof e.getParameter==="function"){const n=e.getParameter("selectedItem");if(n&&typeof n.getKey==="function"){t=n.getKey()}}if(!t){const e=this._oSimulationDialog.getModel("local");t=e?e.getProperty("/unitId"):null}if(!t)return;const n=this._oSimulationDialog.getModel("units");const i=n?n.getData():[];const a=i.find(e=>e.unitId===t);if(a){const e=a.project?.projectId||a.projectId;const n=a.project?.projectDescription||a.projectDescription;const i=this._oSimulationDialog.getModel("local");i.setProperty("/projectId",e);i.setProperty("/projectDescription",n);this._calculateFinalPricePPS(t,i)}},_calculateFinalPricePPS:async function(e,t){try{const n=await fetch(`./odata/v4/real-estate/Conditions?$filter=unit_unitId eq '${e}'`);const i=await n.json();const a=i.value||[];const o=a.reduce((e,t)=>e+Number(t.amount||0),0);t.setProperty("/finalPrice",o)}catch(e){console.error("Failed to calculate final price for PPS:",e)}},onPricePlanChangePPS:function(e){const t=parseInt(e.getParameter("value"));const n=sap.ui.getCore().byId("projectIdInputPPS").getValue();const i=this._oSimulationDialog.getModel("paymentPlans");const a=i?i.getData():[];const o=a.find(e=>e.planYears===t&&Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===n));if(o){sap.ui.getCore().byId("paymentPlanIdInputPPS").setValue(o.paymentPlanId)}else{sap.ui.getCore().byId("paymentPlanIdInputPPS").setValue("")}},onSimulatePPS:async function(){const e=this._oSimulationDialog.getModel("local");const n=e?e.getProperty("/unitId"):null;const i=e?Number(e.getProperty("/finalPrice")):NaN;const a=sap.ui.getCore().byId("projectIdInputPPS").getValue();const o=sap.ui.getCore().byId("paymentPlanIdInputPPS").getValue();const s=parseInt(sap.ui.getCore().byId("pricePlanInputPPS").getValue());const r=sap.ui.getCore().byId("leadIdInputPPS").getValue();if(!n){t.error("Please select a unit.");return}const l=this._oSimulationDialog.getModel("paymentPlans");const p=l?l.getData():[];const u=p.find(e=>e.planYears===s&&Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===a));if(!u){t.error("No payment plan exists for the selected years and project.");return}if(!o||!i||isNaN(i)){t.error("Please fill all required fields.");return}try{const t=await fetch(`./odata/v4/real-estate/PaymentPlanSchedules?$filter=paymentPlan_paymentPlanId eq '${o}'&$expand=conditionType,basePrice,frequency`);const i=await t.json();const a=i.value||[];const s=await fetch(`./odata/v4/real-estate/Conditions?$filter=unit_unitId eq '${n}'`);const r=await s.json();const l=r.value||[];const p=[];const u=new Date;a.forEach(e=>{const t=e.basePrice?.code;const n=l.find(e=>e.code===t);const i=n?Number(n.amount):0;const a=i*e.percentage/100;const o=this._getFrequencyIntervalPPS(e.frequency?.description);if(e.conditionType?.description==="Maintenance"){for(let t=0;t<(e.numberOfInstallments||1);t++){const n=e.dueInMonth+t*o;const i=new Date(u.getTime()+n*30*24*60*60*1e3);p.push({conditionType:e.conditionType.description,dueDate:i.toISOString().split("T")[0],amount:0,maintenance:Math.round(a/Math.max(1,e.numberOfInstallments)*100)/100})}}else{for(let t=0;t<(e.numberOfInstallments||1);t++){const n=e.dueInMonth+t*o;const i=new Date(u.getTime()+n*30*24*60*60*1e3);p.push({conditionType:e.conditionType?.description||"Installment",dueDate:i.toISOString().split("T")[0],amount:Math.round(a/Math.max(1,e.numberOfInstallments)*100)/100,maintenance:0})}}});this._oSimulationDialog.getModel("simulationOutput").setData(p);const c=sap.ui.getCore().byId("simulationTablePPS");if(c&&c.getBinding("items")){c.getBinding("items").refresh()}const d=this._generateIdPPS();sap.ui.getCore().byId("simIdInput").setValue(d);e.setProperty("/simulationId",d)}catch(e){t.error("Simulation failed: "+(e.message||e))}},onSaveSimulationPPS:async function(){const e=sap.ui.getCore().byId("simIdInput").getValue();const n=this._oSimulationDialog.getModel("local");const i=n?n.getProperty("/unitId"):null;const a=sap.ui.getCore().byId("projectIdInputPPS").getValue();const o=sap.ui.getCore().byId("paymentPlanIdInputPPS").getValue();const s=parseInt(sap.ui.getCore().byId("pricePlanInputPPS").getValue());const r=sap.ui.getCore().byId("leadIdInputPPS").getValue();const l=Number(n?n.getProperty("/finalPrice"):NaN);const p="currentUser";const u=this._oSimulationDialog.getModel("simulationOutput").getData();try{const t={simulationId:e,unitId:i,projectId:a,pricePlanYears:s,leadId:r,finalPrice:l,userId:p,schedule:(u||[]).map(e=>({conditionType:e.conditionType,dueDate:e.dueDate,amount:e.amount,maintenance:e.maintenance}))};const n=await fetch("./odata/v4/real-estate/PaymentPlanSimulations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error("Failed to save simulation");w.show("Simulation saved successfully!")}catch(e){t.error("Error: "+(e.message||e))}},_getFrequencyIntervalPPS:function(e){if(!e)return 12;switch(e.toLowerCase()){case"monthly":return 1;case"quarterly":return 3;case"semi-annual":return 6;case"annual":return 12;default:return 12}},_generateIdPPS:function(){this._idCounter+=1;localStorage.setItem("simulationIdCounter",this._idCounter);const e=("00000"+this._idCounter).slice(-5);return"PPS"+e},onProjectChange:function(e){var t=e.getSource();var n=t.getSelectedKey();var i=t.getSelectedItem();var a=i?i.getText().split(" - ")[1]||"":"";var o=this._oAddDialog.getModel();o.setProperty("/projectDescription",a);const s=this.getView().getModel("projectsList").getData();const r=s.find(e=>e.projectId===n);if(r){console.log(r);o.setProperty("/profitCenter",r.profitCenter||0);o.setProperty("/functionalArea",r.functionalArea||0)}else{o.setProperty("/profitCenter","");o.setProperty("/functionalArea","")}}})});
//# sourceMappingURL=Units.controller.js.map