sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,n,o,a,s){"use strict";return e.extend("dboperations.controller.PaymentPlans",{onInit:function(){this.oModel=this.getView().getModel();this._loadPlans();this._loadDropdownData();this._idCounter=parseInt(localStorage.getItem("simulationIdCounter"))||0},_loadDropdownData:async function(){try{const e=["./odata/v4/real-estate/ConditionTypes","./odata/v4/real-estate/BasePrices","./odata/v4/real-estate/CalculationMethods","./odata/v4/real-estate/Frequencies","./odata/v4/real-estate/Projects"];const t=await Promise.allSettled(e.map(async e=>{try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP ${t.status} for ${e}`);return await t.json()}catch(t){console.error(`❌ Failed to fetch ${e}:`,t);return{value:[]}}}));const[n,a,s,r,i]=t.map(e=>e.status==="fulfilled"?e.value:{value:[]});const l=new o({conditionTypes:(n.value||[]).map(e=>({code:e.code||e.conditionTypeId||e.id,description:e.description||e.conditionTypeDescription})),basePrices:(a.value||[]).map(e=>({code:e.code||e.basePriceId||e.id,description:e.description||e.basePriceDescription})),calculationMethods:(s.value||[]).map(e=>({code:e.code||e.calculationMethodId||e.id,description:e.description||e.calculationMethodDescription})),frequencies:(r.value||[]).map(e=>({code:e.code||e.frequencyId||e.id,description:e.description||e.frequencyDescription})),projects:(i.value||[]).map(e=>({code:e.projectId,description:e.projectDescription})),planStatuses:[{code:"A",description:"Approved"},{code:"I",description:"Initial"}]});this.getView().setModel(l,"dropdowns");console.log("✅ Dropdown data loaded",l.getData());console.log("RAW ConditionTypes:",n);console.log("RAW BasePrices:",a);console.log("RAW CalcMethods:",s);console.log("RAW Frequencies:",r);console.log("RAW Projects:",i)}catch(e){console.error("❌ Overall error loading dropdown data:",e);n.error("Failed to load dropdown data. Check console for details.")}},_loadPlans:function(){fetch("./odata/v4/real-estate/PaymentPlans?$expand=schedule($expand=conditionType,basePrice,calculationMethod,frequency),assignedProjects($expand=project)").then(e=>e.json()).then(e=>{this.getView().setModel(new o(e.value||[]),"plans")}).catch(e=>console.error("Failed to load plans:",e))},onShowPlanDetails:async function(e){const t=e.getSource().getBindingContext("plans");if(!t)return;const a=t.getProperty("paymentPlanId");try{const e=await fetch(`./odata/v4/real-estate/PaymentPlans(paymentPlanId='${a}')?$expand=schedule($expand=conditionType,basePrice,calculationMethod,frequency),assignedProjects($expand=project)`);if(!e.ok)throw new Error("Failed to load plan details");const t=await e.json();const n=t.value?t.value[0]:t;const s=new o(n);if(!this._oDetailsDialog){this._oDetailsDialog=new sap.m.Dialog({title:"Payment Plan Details",contentWidth:"90%",resizable:true,draggable:true,content:[new sap.m.IconTabBar({items:[new sap.m.IconTabFilter({text:"General Info",content:[new sap.ui.layout.form.SimpleForm({editable:false,content:[new sap.m.Label({text:"Payment Plan ID"}),new sap.m.Text({text:"{/paymentPlanId}"}),new sap.m.Label({text:"Description"}),new sap.m.Text({text:"{/description}"}),new sap.m.Label({text:"Company Code"}),new sap.m.Text({text:"{/companyCodeId}"}),new sap.m.Label({text:"Years"}),new sap.m.Text({text:"{/planYears}"}),new sap.m.Label({text:"Valid From"}),new sap.m.Text({text:"{/validFrom}"}),new sap.m.Label({text:"Valid To"}),new sap.m.Text({text:"{/validTo}"}),new sap.m.Label({text:"Status"}),new sap.m.Text({text:"{/planStatus}"})]})]}),new sap.m.IconTabFilter({text:"Schedules",content:[new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:"Condition Type"})}),new sap.m.Column({header:new sap.m.Label({text:"Base Price"})}),new sap.m.Column({header:new sap.m.Label({text:"Frequency"})}),new sap.m.Column({header:new sap.m.Label({text:"%"})}),new sap.m.Column({header:new sap.m.Label({text:"Due (Months)"})}),new sap.m.Column({header:new sap.m.Label({text:"Installments"})}),new sap.m.Column({header:new sap.m.Label({text:"Years"})})],items:{path:"/schedule",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{conditionType/description}"}),new sap.m.Text({text:"{basePrice/description}"}),new sap.m.Text({text:"{frequency/description}"}),new sap.m.Text({text:"{percentage}"}),new sap.m.Text({text:"{dueInMonth}"}),new sap.m.Text({text:"{numberOfInstallments}"}),new sap.m.Text({text:"{numberOfYears}"})]})}})]}),new sap.m.IconTabFilter({text:"Assigned Projects",content:[new sap.m.Table({columns:[new sap.m.Column({header:new sap.m.Label({text:"Project ID"})}),new sap.m.Column({header:new sap.m.Label({text:"Description"})})],items:{path:"/assignedProjects",template:new sap.m.ColumnListItem({cells:[new sap.m.Text({text:"{project/projectId}"}),new sap.m.Text({text:"{project/projectDescription}"})]})}})]})]})],endButton:new sap.m.Button({text:"Close",press:function(){this._oDetailsDialog.close()}.bind(this)})});this.getView().addDependent(this._oDetailsDialog)}this._oDetailsDialog.setModel(s);this._oDetailsDialog.open()}catch(e){n.error("Error: "+e.message)}},onAddPlan:function(){this._openPlanDialog({})},onEditPlan:async function(e){const t=e.getSource().getBindingContext("plans");const o=t.getProperty("paymentPlanId");try{const e=await fetch(`./odata/v4/real-estate/PaymentPlans(paymentPlanId='${o}')?$expand=schedule($expand=conditionType,basePrice,calculationMethod,frequency),assignedProjects($expand=project)`);if(!e.ok)throw new Error("Failed to load payment plan for edit");const t=await e.json();const n=t.value?t.value[0]:t;this._openPlanDialog(n)}catch(e){n.error("Error: "+e.message)}},_openPlanDialog:function(e){if(!this._oAddDialog){this._oAddDialog=this.getView().byId("planDialog")}const t=(e.schedule||[]).map(e=>({conditionType:e.conditionType?{code:e.conditionType.code,description:e.conditionType.description}:{},basePrice:e.basePrice?{code:e.basePrice.code,description:e.basePrice.description}:{},calculationMethod:e.calculationMethod?{code:e.calculationMethod.code,description:e.calculationMethod.description}:{},frequency:e.frequency?{code:e.frequency.code,description:e.frequency.description}:{},percentage:e.percentage||0,dueInMonth:e.dueInMonth||0,numberOfInstallments:e.numberOfInstallments||0,numberOfYears:e.numberOfYears||0}));const n=new o({paymentPlanId:e.paymentPlanId||"",description:e.description||"",companyCodeId:e.companyCodeId||"",planYears:e.planYears||0,validFrom:e.validFrom||"",validTo:e.validTo||"",planStatus:e.planStatus||"",schedules:t,projects:(e.assignedProjects||[]).map(e=>({projectId:e.project?.projectId||"",projectDescription:e.project?.projectDescription||""}))});this._oAddDialog.setModel(n,"local");this._oAddDialog.open()},onSavePlan:async function(){const e=this._oAddDialog;const o=e.getModel("local");const a=o.getData();if(!a.validFrom){n.error("Valid From is required.");return}if(!a.validTo){n.error("Valid To is required.");return}const s=new Date(a.validFrom);const r=new Date(a.validTo);if(isNaN(s.getTime())||isNaN(r.getTime())){n.error("Valid From and Valid To must be valid dates.");return}if(r<s){n.error("Valid To cannot be earlier than Valid From.");return}try{const o=(a.schedules||[]).map(e=>({conditionType_code:e.conditionType?.code||"",basePrice_code:e.basePrice?.code||"",calculationMethod_code:e.calculationMethod?.code||"",frequency_code:e.frequency?.code||"",percentage:e.percentage||0,dueInMonth:e.dueInMonth||0,numberOfInstallments:e.numberOfInstallments||0,numberOfYears:e.numberOfYears||0}));const s=(a.projects||[]).map(e=>({project_projectId:e.projectId||""}));const r={paymentPlanId:a.paymentPlanId||this._generateId(),description:a.description,companyCodeId:a.companyCodeId,planYears:a.planYears,validFrom:a.validFrom,validTo:a.validTo,planStatus:a.planStatus,schedule:o,assignedProjects:s};const i=a.paymentPlanId?"PUT":"POST";const l=a.paymentPlanId?`./odata/v4/real-estate/PaymentPlans(paymentPlanId='${a.paymentPlanId}')`:`./odata/v4/real-estate/PaymentPlans`;console.log("Schedules payload:",o);console.log("Assigned projects payload:",s);const c=parseInt(a.planYears)||0;const d=(a.schedules||[]).filter(e=>!e.conditionType?.description?.toLowerCase().includes("maintenance")).reduce((e,t)=>e+(parseFloat(t.percentage)||0),0);if(d!==100){n.error(`Total percentage for installments and downpayment must be 100. Current: ${d}`);return}const p=(a.schedules||[]).reduce((e,t)=>e+(parseInt(t.numberOfYears)||0),0);if(p!==c){n.error(`Total years in schedules must equal plan years (${c}). Current: ${p}`);return}const m=await fetch(l,{method:i,headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!m.ok)throw new Error("Failed to save payment plan");t.show("Payment plan saved successfully!");e.close();this._loadPlans()}catch(e){n.error("Error: "+e.message)}},onCancelPlan:function(){this._oAddDialog.close()},onAddScheduleRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/schedules");t.push({});e.refresh()},onDeleteScheduleRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/schedules");t.pop();e.refresh()},onAddProjectRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/projects");t.push({});e.refresh()},onDeleteProjectRow:function(){const e=this._oAddDialog.getModel("local");const t=e.getProperty("/projects");t.pop();e.refresh()},_generateId:function(){this._idCounter+=1;localStorage.setItem("simulationIdCounter",this._idCounter);const e=("00000"+this._idCounter).slice(-5);return"PP"+e},onDeletePlan:function(e){const o=e.getSource().getBindingContext("plans");const a=o.getObject();n.confirm(`Delete plan ${a.paymentPlanId}?`,{onClose:async e=>{if(e==="OK"){try{const e=await fetch(`./odata/v4/real-estate/PaymentPlans('${a.paymentPlanId}')`,{method:"DELETE"});if(!e.ok)throw new Error("Delete failed");t.show("Deleted successfully");this._loadPlans()}catch(e){n.error(e.message)}}}})},_onValueHelpConfirm:function(e,t,n,o){const a=e.getParameter("selectedItem");if(a){const e=a.getBindingContext("dropdowns");if(e){const a=e.getObject();o({code:a[t],description:a[n]})}}},onOpenPlanStatusVHD:function(e){var t=new sap.m.SelectDialog({title:"Select Plan Status",items:{path:"dropdowns>/planStatuses",template:new sap.m.StandardListItem({title:"{dropdowns>description}",description:"{dropdowns>code}",type:"Active"})},liveChange:function(e){var t=e.getParameter("value");e.getParameter("itemsBinding").filter([new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,t)])},confirm:function(e){var t=e.getParameter("selectedItem");if(t){var n=t.getBindingContext("dropdowns").getObject();var o=this.getView().byId("planDialog").getModel("local");o.setProperty("/planStatus",n.code)}}.bind(this)});t.setModel(this.getView().getModel("dropdowns"),"dropdowns");t.open()},onOpenConditionTypeVHD:function(e){var t=e.getSource();var n=t.getBindingContext("local");this._openValueHelpDialog("Condition Type","dropdowns>/conditionTypes",n,"conditionType")},onOpenBasePriceVHD:function(e){var t=e.getSource();var n=t.getBindingContext("local");this._openValueHelpDialog("Base Price","dropdowns>/basePrices",n,"basePrice")},onOpenFrequencyVHD:function(e){var t=e.getSource();var n=t.getBindingContext("local");var o=new sap.m.SelectDialog({title:"Select Frequency",items:{path:"dropdowns>/frequencies",template:new sap.m.StandardListItem({title:"{dropdowns>description}",description:"{dropdowns>code}",type:"Active"})},liveChange:function(e){var t=e.getParameter("value");e.getParameter("itemsBinding").filter([new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,t)])},confirm:function(e){var t=e.getParameter("selectedItem");if(t){var o=t.getBindingContext("dropdowns");var a=o.getObject();n.setProperty("frequency",a);var s=parseInt(n.getProperty("numberOfYears"))||0;if(s>0){this._calculateInstallments(n)}}}.bind(this)});o.setModel(this.getView().getModel("dropdowns"),"dropdowns");o.open()},onOpenProjectVHD:function(e){var t=e.getSource();var n=t.getBindingContext("local");var o=new sap.m.SelectDialog({title:"Select Project",items:{path:"dropdowns>/projects",template:new sap.m.StandardListItem({title:"{dropdowns>description}",description:"{dropdowns>code}",type:"Active"})},liveChange:function(e){var t=e.getParameter("value");e.getParameter("itemsBinding").filter([new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,t)])},confirm:function(e){var t=e.getParameter("selectedItem");if(t){var o=t.getBindingContext("dropdowns").getObject();n.setProperty("projectId",o.code);n.setProperty("projectDescription",o.description)}}});o.setModel(this.getView().getModel("dropdowns"),"dropdowns");o.open()},_openValueHelpDialog:function(e,t,n,o){var a=this;var s=new sap.m.SelectDialog({title:e,items:{path:t,template:new sap.m.StandardListItem({title:"{dropdowns>description}",description:"{dropdowns>code}",type:"Active"})},liveChange:function(e){var t=e.getParameter("value");var n=e.getParameter("itemsBinding");n.filter([new sap.ui.model.Filter("description",sap.ui.model.FilterOperator.Contains,t)])},confirm:function(e){var t=e.getParameter("selectedItem");if(t){var a=t.getBindingContext("dropdowns");var s=a.getObject();n.setProperty(o,s)}}});s.setModel(this.getView().getModel("dropdowns"),"dropdowns");s.open()},onFrequencyChange:function(e){var t=e.getSource().getBindingContext("local");var n=parseInt(t.getProperty("numberOfYears"))||0;if(n>0){this._calculateInstallments(t)}},onYearsChange:function(e){var t=e.getSource().getBindingContext("local");var n=t.getProperty("frequency/description")||"";if(n){this._calculateInstallments(t)}},_calculateInstallments:function(e){var t=e.getProperty("frequency/description")||"";var n=parseInt(e.getProperty("numberOfYears"))||0;var o=0;switch(t.toLowerCase()){case"one time":o=1;break;case"monthly":o=12*n;break;case"quarterly":o=4*n;break;case"semi-annual":o=2*n;break;case"annual":o=1*n;break;default:o=0}e.setProperty("numberOfInstallments",o)}})});
//# sourceMappingURL=PaymentPlans.controller.js.map