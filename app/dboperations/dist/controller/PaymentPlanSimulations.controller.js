sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel"],function(e,t,n,i){"use strict";return e.extend("dboperations.controller.PaymentPlanSimulations",{onInit:function(){this.getView().setModel(new i({}),"local");this.getView().setModel(new i([]),"simulationOutput");this._loadUnits();this._loadDropdownData();this._idCounter=parseInt(localStorage.getItem("simulationIdCounter"))||0},onOpenUnitValueHelp:function(){const e=this.getView();if(!this._oUnitValueHelp){this._oUnitValueHelp=new sap.m.SelectDialog({title:"Select Unit",items:{path:"units>/",template:new sap.m.StandardListItem({title:"{units>unitDescription}",description:"{units>unitId}"})},search:function(e){const t=e.getParameter("value")||"";const n=[new sap.ui.model.Filter("unitDescription",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("unitId",sap.ui.model.FilterOperator.Contains,t)];e.getSource().getBinding("items").filter(new sap.ui.model.Filter(n,false))},confirm:function(t){const n=t.getParameter("selectedItem");if(n){const t=n.getBindingContext("units");const i=t.getObject();const o=i.unitId;const s=i.unitDescription;const a=e.getModel("local");a.setProperty("/unitId",o);const r=e.byId("unitIdInput");if(r){r.setValue(`${s} (${o})`)}this._onUnitSelected(o)}}.bind(this),liveChange:function(e){const t=e.getParameter("value")||"";const n=[new sap.ui.model.Filter("unitDescription",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("unitId",sap.ui.model.FilterOperator.Contains,t)];e.getSource().getBinding("items").filter(new sap.ui.model.Filter(n,false))}});e.addDependent(this._oUnitValueHelp)}this._oUnitValueHelp.open()},_onUnitSelected:function(e){this.onUnitChange({getParameter:()=>({selectedItem:{getKey:()=>e}})})},_loadUnits:function(){fetch("./odata/v4/real-estate/Units?$expand=project").then(e=>e.json()).then(e=>{this.getView().setModel(new i(e.value||[]),"units");console.log("Units loaded:",e);const t=this.getView().byId("unitIdSelect");if(t&&t.getBinding("items")){t.getBinding("items").refresh()}}).catch(e=>console.error("Failed to load units:",e))},_loadDropdownData:async function(){try{const[e,t]=await Promise.all([fetch("./odata/v4/real-estate/Projects"),fetch("./odata/v4/real-estate/PaymentPlans?$expand=assignedProjects($expand=project)")]);const n=await e.json();const o=await t.json();this.getView().setModel(new i(n.value||[]),"projects");this.getView().setModel(new i(o.value||[]),"paymentPlans")}catch(e){console.error("Failed to load dropdown data:",e)}},onUnitChange:async function(e){let t=null;if(e&&typeof e.getParameter==="function"){const n=e.getParameter("selectedItem");if(n&&typeof n.getKey==="function"){t=n.getKey()}}if(!t){const e=this.getView().byId("unitIdSelect");if(e&&typeof e.getSelectedKey==="function"){t=e.getSelectedKey()}}if(!t){const e=this.getView().getModel("local");t=e?e.getProperty("/unitId"):null}if(!t){console.warn("onUnitChange: no unit selected.");return}const n=this.getView().getModel("units");const i=n?n.getData():[];const o=(i||[]).find(e=>e.unitId===t);console.log("Selected unit:",o);if(o){const e=o.project?.projectId||o.projectId;const n=o.project?.projectDescription||o.projectDescription;if(e){const i=this.getView().getModel("local");i.setProperty("/projectId",e);i.setProperty("/projectDescription",n);try{const e=await fetch(`./odata/v4/real-estate/Conditions?$filter=unit_unitId eq '${t}'`);const n=await e.json();const o=n.value||[];console.log("Conditions for unit:",o);const s=(o||[]).reduce((e,t)=>{const n=Number(t.amount)||0;return e+n},0);i.setProperty("/finalPrice",s);console.log("Final Price set to:",s)}catch(e){console.error("Failed to calculate final price:",e)}}else{console.warn("No project info on selected unit.")}}else{console.warn("Selected unit not found in units model.")}},onPricePlanChange:function(e){const t=parseInt(e.getParameter("value"));const n=this.getView().byId("projectIdInput").getValue();const i=this.getView().getModel("paymentPlans");const o=i?i.getData():[];const s=(o||[]).find(e=>e.planYears===t&&Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===n));if(s){this.getView().byId("paymentPlanIdInput").setValue(s.paymentPlanId)}else{this.getView().byId("paymentPlanIdInput").setValue("")}},onSimulate:async function(){debugger;const e=this.getView().getModel("local");const t=e?e.getProperty("/unitId"):null;const o=e?Number(e.getProperty("/finalPrice")):NaN;const s=this.getView().byId("projectIdInput").getValue();const a=this.getView().byId("paymentPlanIdInput").getValue();const r=parseInt(this.getView().byId("pricePlanInput").getValue());const l=this.getView().byId("leadIdInput").getValue();const c="currentUser";if(!t){n.error("Please select a unit.");return}const u=this.getView().getModel("paymentPlans");const d=u?u.getData():[];const p=d.find(e=>e.planYears===r&&Array.isArray(e.assignedProjects)&&e.assignedProjects.some(e=>e.project?.projectId===s));if(!p){n.error("No payment plan exists for the selected years and project. Please enter a valid number of years.");return}if(!a){n.error("Payment Plan ID is not set. Please ensure the years are valid.");return}if(!o||isNaN(o)){n.error("Please fill all required fields (Final Price).");return}try{const n=await fetch(`./odata/v4/real-estate/PaymentPlanSchedules?$filter=paymentPlan_paymentPlanId eq '${a}'&$expand=conditionType,basePrice,frequency`);const o=await n.json();const s=o.value||[];const r=await fetch(`./odata/v4/real-estate/Conditions?$filter=unit_unitId eq '${t}'`);const l=await r.json();const c=l.value||[];const u=[];const d=new Date;s.forEach(e=>{const t=e.basePrice?.code;const n=c.find(e=>e.code===t);const i=n?Number(n.amount):0;const o=i*e.percentage/100;const s=this._getFrequencyInterval(e.frequency?.description);if(e.conditionType?.description==="Maintenance"){for(let t=0;t<(e.numberOfInstallments||1);t++){const n=e.dueInMonth+t*s;const i=new Date(d.getTime()+n*30*24*60*60*1e3);u.push({conditionType:e.conditionType.description,dueDate:i.toISOString().split("T")[0],amount:0,maintenance:o/Math.max(1,e.numberOfInstallments)})}}else{for(let t=0;t<(e.numberOfInstallments||1);t++){const n=e.dueInMonth+t*s;const i=new Date(d.getTime()+n*30*24*60*60*1e3);u.push({conditionType:e.conditionType?.description||"Installment",dueDate:i.toISOString().split("T")[0],amount:o/Math.max(1,e.numberOfInstallments),maintenance:0})}}});this.getView().setModel(new i(u),"simulationOutput");const p=this.getView().byId("simulationTable");if(p&&p.getBinding("items")){p.getBinding("items").refresh()}const g=this._generateId();this.getView().byId("simulationIdInput").setValue(g);e.setProperty("/simulationId",g)}catch(e){n.error("Simulation failed: "+(e.message||e))}},_getFrequencyInterval:function(e){if(!e)return 12;switch(e.toLowerCase()){case"monthly":return 1;case"quarterly":return 3;case"semi-annual":return 6;case"annual":return 12;default:return 12}},onSaveSimulation:async function(){const e=this.getView().byId("simulationIdInput").getValue();const i=this.getView().getModel("local");const o=i?i.getProperty("/unitId"):null;const s=this.getView().byId("projectIdInput").getValue();const a=this.getView().byId("paymentPlanIdInput").getValue();const r=parseInt(this.getView().byId("pricePlanInput").getValue());const l=this.getView().byId("leadIdInput").getValue();const c=Number(i?i.getProperty("/finalPrice"):NaN);const u="currentUser";const d=this.getView().getModel("simulationOutput").getData();try{const n={simulationId:e,unitId:o,projectId:s,pricePlanYears:r,leadId:l,finalPrice:c,userId:u,schedule:(d||[]).map(e=>({conditionType:e.conditionType,dueDate:e.dueDate,amount:e.amount,maintenance:e.maintenance}))};const i=await fetch("./odata/v4/real-estate/PaymentPlanSimulations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok)throw new Error("Failed to save simulation");t.show("Simulation saved successfully!")}catch(e){n.error("Error: "+(e.message||e))}},_generateId:function(){this._idCounter+=1;localStorage.setItem("simulationIdCounter",this._idCounter);const e=("00000"+this._idCounter).slice(-5);return"PPS"+e}})});
//# sourceMappingURL=PaymentPlanSimulations.controller.js.map